---
- name: add wordpress db
  mysql_db:
    name: "{{wordpress.db_name}}"
    encoding: utf8
    state: present

- name: add worpdress db user
  mysql_user:
    name: "{{wordpress.db_user}}"
    password: "{{wordpress.db_password}}"
    priv: "{{wordpress.db_name}}.*:ALL"
    host: localhost

- name: download wordpress
  get_url:
    url: https://ja.wordpress.org/latest-ja.tar.gz
    dest: /usr/local/src/wordpress.tar.gz

- name: install wordpress
  unarchive:
    src: /usr/local/src/wordpress.tar.gz
    dest: /var/www
    group: "{{php_fpm.group}}"
    owner: "{{php_fpm.user}}"
    copy: no
    creates: /var/www/wordpress

- name: generate wordpress private key, csr and crt
  shell: |
    openssl req -x509 -nodes -new -newkey rsa:2048 -keyout wordpress.key -out wordpress.crt \
    -subj "/C={{wordpress.ssl.Country}}/ST={{wordpress.ssl.State}}/L={{wordpress.ssl.Locality}}/CN={{wordpress.ssl.CommonName}}" chdir="{{ssl.dir}}"
  args:
    creates: "{{ssl.dir}}/wordpress.crt"

- name: change nginx defaut.conf for php
  template: src=nginx_wordpress.conf.j2 dest=/etc/nginx/conf.d/wordpress.conf backup=yes
  notify: restart nginx
  tags:
    - php
    - nginx
